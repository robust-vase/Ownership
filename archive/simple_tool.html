<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simple Object Ownership Tool</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f0f2f5;
            height: 100vh;
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .header h1 {
            font-size: 24px;
            font-weight: 600;
        }
        
        .header p {
            font-size: 14px;
            opacity: 0.9;
            margin-top: 5px;
        }
        
        .container {
            display: grid;
            grid-template-columns: 1.5fr 1fr;
            gap: 20px;
            padding: 20px;
            height: calc(100vh - 100px);
        }
        
        .panel {
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        .panel-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 20px;
            font-size: 18px;
            font-weight: 600;
        }
        
        /* Left Panel - Visualization */
        .viz-panel {
            position: relative;
        }
        
        .image-container {
            flex: 1;
            position: relative;
            overflow: auto;
            background: #1a1a2e;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .camera-image {
            max-width: 100%;
            max-height: 100%;
            display: block;
        }
        
        .svg-overlay {
            position: absolute;
            top: 0;
            left: 0;
            pointer-events: none;
        }
        
        .object-polygon {
            fill: rgba(255, 165, 0, 0.2);
            stroke: rgba(255, 165, 0, 0.8);
            stroke-width: 2;
            cursor: pointer;
            pointer-events: all;
            transition: all 0.2s ease;
        }
        
        .object-polygon:hover {
            fill: rgba(255, 165, 0, 0.4);
            stroke: rgba(255, 165, 0, 1);
            stroke-width: 3;
        }
        
        .object-polygon.highlighted {
            fill: rgba(255, 215, 0, 0.5);
            stroke: rgba(255, 215, 0, 1);
            stroke-width: 4;
            filter: drop-shadow(0 0 10px rgba(255, 215, 0, 0.8));
        }
        
        .agent-polygon {
            fill: rgba(100, 149, 237, 0.15);
            stroke: rgba(100, 149, 237, 0.6);
            stroke-width: 2;
            stroke-dasharray: 5,5;
            pointer-events: all;
        }
        
        .agent-polygon.highlighted {
            fill: rgba(100, 149, 237, 0.3);
            stroke: rgba(100, 149, 237, 1);
            stroke-width: 3;
            filter: drop-shadow(0 0 8px rgba(100, 149, 237, 0.6));
        }
        
        /* Right Panel - Matching Interface */
        .matching-panel {
            display: flex;
            flex-direction: column;
        }
        
        .matching-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }
        
        .section {
            margin-bottom: 30px;
        }
        
        .section-title {
            font-size: 16px;
            font-weight: 600;
            color: #333;
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 2px solid #667eea;
        }
        
        .object-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .object-item {
            background: #f8f9fa;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 12px;
            transition: all 0.2s ease;
        }
        
        .object-item:hover {
            border-color: #667eea;
            background: #f0f4ff;
            transform: translateX(5px);
        }
        
        .object-item.highlighted {
            border-color: #ffd700;
            background: #fffbf0;
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.3);
        }
        
        .object-name {
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
            font-size: 14px;
        }
        
        .owner-select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
            background: white;
            cursor: pointer;
            transition: border-color 0.2s ease;
        }
        
        .owner-select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 5px rgba(102, 126, 234, 0.3);
        }
        
        .agent-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .agent-item {
            background: #e3f2fd;
            border: 2px solid #90caf9;
            border-radius: 8px;
            padding: 10px 15px;
            font-weight: 500;
            color: #1565c0;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .agent-item:hover {
            background: #bbdefb;
            border-color: #42a5f5;
            transform: translateX(5px);
        }
        
        .agent-item.highlighted {
            background: #ffd54f;
            border-color: #ffc107;
            color: #f57f17;
            box-shadow: 0 0 15px rgba(255, 193, 7, 0.4);
        }
        
        .submit-section {
            padding: 20px;
            border-top: 2px solid #e0e0e0;
            background: #f8f9fa;
        }
        
        .submit-button {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }
        
        .submit-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }
        
        .submit-button:active {
            transform: translateY(0);
        }
        
        .status-message {
            margin-top: 10px;
            padding: 10px;
            border-radius: 5px;
            font-size: 14px;
            text-align: center;
            display: none;
        }
        
        .status-message.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status-message.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .legend {
            padding: 15px 20px;
            background: #f8f9fa;
            border-top: 1px solid #e0e0e0;
            display: flex;
            gap: 20px;
            font-size: 13px;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 3px;
            border: 2px solid;
        }
        
        .legend-color.object {
            background: rgba(255, 165, 0, 0.2);
            border-color: rgba(255, 165, 0, 0.8);
        }
        
        .legend-color.agent {
            background: rgba(100, 149, 237, 0.15);
            border-color: rgba(100, 149, 237, 0.6);
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ðŸŽ¯ Object Ownership Annotation Tool</h1>
        <p>Scene: table_scene_map205_room_diningRoom_table1 | Camera: BP_DiningTable_23_C_0_Camera_3</p>
    </div>
    
    <div class="container">
        <!-- Left Panel: Image Visualization -->
        <div class="panel viz-panel">
            <div class="panel-header">ðŸ“· Camera View</div>
            <div class="image-container" id="imageContainer">
                <img src="/logs/table_scene_map205_room_diningRoom_table1/BP_DiningTable_23_C_0_Camera_3_rgb.png" alt="Camera View" class="camera-image" id="cameraImage">
                <svg class="svg-overlay" id="svgOverlay"></svg>
            </div>
            <div class="legend">
                <div class="legend-item">
                    <div class="legend-color object"></div>
                    <span>Objects</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color agent"></div>
                    <span>Agents (Reference)</span>
                </div>
            </div>
        </div>
        
        <!-- Right Panel: Ownership Matching -->
        <div class="panel matching-panel">
            <div class="panel-header">ðŸ”— Ownership Matching</div>
            <div class="matching-content">
                <div class="section">
                    <div class="section-title">ðŸ“¦ Visible Objects</div>
                    <div class="object-list" id="objectList">
                        <!-- Dynamically populated -->
                    </div>
                </div>
                
                <div class="section">
                    <div class="section-title">ðŸ‘¥ Agents (Reference)</div>
                    <div class="agent-list" id="agentList">
                        <!-- Dynamically populated -->
                    </div>
                </div>
            </div>
            
            <div class="submit-section">
                <button class="submit-button" id="submitButton">ðŸ’¾ Save Ownership Data</button>
                <div class="status-message" id="statusMessage"></div>
            </div>
        </div>
    </div>
    
    <script>
        // Embedded data
        const objectsData = [{"id": "BP_Chair_0_C_2146084263", "display_name": "Chair", "type": "chair", "polygon": [[3127.3649264733403, 2870.8099891946213], [4096, 2870.8099891946213], [4096, 4096], [3127.3649264733403, 4096]], "owner": "room", "matched": false}, {"id": "BP_Chair_0_C_2146084261", "display_name": "Chair", "type": "chair", "polygon": [[2225.8015361419157, 2116.026475989924], [3829.9464509818786, 2116.026475989924], [3829.9464509818786, 4096], [2225.8015361419157, 4096]], "owner": "room", "matched": false}, {"id": "BP_Painting_14_C_0", "display_name": "Painting", "type": "painting", "polygon": [[0, 1086.9217619053716], [4096, 1086.9217619053716], [4096, 4096], [0, 4096]], "owner": "room", "matched": false}, {"id": "BP_Toy_Dog_C_2146083345", "display_name": "Toy", "type": "BP_Toy_Dog", "polygon": [[2581.034028994625, 1772.8403555491354], [2897.2492589417825, 1772.8403555491354], [2897.2492589417825, 2360.662740377522], [2581.034028994625, 2360.662740377522]], "owner": "SDBP_Aich_AIBaby_Lele_Shoes_C_2146083531", "matched": false}, {"id": "BP_Plate_02_TL_C_2146083338", "display_name": "Plate", "type": "BP_Plate_02_TL", "polygon": [[2315.0654240421313, 1722.7153702633705], [2664.7811281927784, 1722.7153702633705], [2664.7811281927784, 1935.1238454044023], [2315.0654240421313, 1935.1238454044023]], "owner": "SDBP_Aich_AIBaby_Lele_Shoes_C_2146083531", "matched": false}, {"id": "BP_Orange_01_C_2146083337", "display_name": "Orange", "type": "BP_Orange_01", "polygon": [[2398.9143709947066, 1647.213817824409], [2655.352789524858, 1647.213817824409], [2655.352789524858, 1874.3764985658713], [2398.9143709947066, 1874.3764985658713]], "owner": "SDBP_Aich_AIBaby_Lele_Shoes_C_2146083531", "matched": false}, {"id": "BP_Mouse_01_C_2146083320", "display_name": "Mouse", "type": "BP_Mouse_01", "polygon": [[2040.2701911377185, 2015.987527350263], [2236.224464333164, 2015.987527350263], [2236.224464333164, 2147.6822791237137], [2040.2701911377185, 2147.6822791237137]], "owner": "SDBP_Aich_Zhanghaoran_C_2146083435", "matched": false}, {"id": "BP_Food_180_C_2146083317", "display_name": "Food", "type": "BP_Food_180", "polygon": [[2104.508174146055, 1651.7822047553223], [2370.3251991383586, 1651.7822047553223], [2370.3251991383586, 2049.878058460026], [2104.508174146055, 2049.878058460026]], "owner": "SDBP_Aich_Zhanghaoran_C_2146083435", "matched": false}, {"id": "BP_Decor_Eyeglasses01Frame01_C_2146083260", "display_name": "Decor", "type": "BP_Decor_Eyeglasses01Frame01", "polygon": [[2555.166167697582, 1493.5468372481037], [2648.1508262279544, 1493.5468372481037], [2648.1508262279544, 1641.7300312301313], [2555.166167697582, 1641.7300312301313]], "owner": "SDBP_Aich_Zhanghaoran_C_2146083435", "matched": false}];
        const agentsData = [{"id": "public", "display_name": "Public/Room", "role": "public", "polygon": []}];
        const sceneName = "table_scene_map205_room_diningRoom_table1";
        
        // State management
        let ownershipMap = {};  // object_id -> owner_id
        
        // DOM elements
        const svgOverlay = document.getElementById('svgOverlay');
        const cameraImage = document.getElementById('cameraImage');
        const objectList = document.getElementById('objectList');
        const agentList = document.getElementById('agentList');
        const submitButton = document.getElementById('submitButton');
        const statusMessage = document.getElementById('statusMessage');
        
        // Initialize SVG overlay dimensions
        cameraImage.addEventListener('load', function() {
            const rect = cameraImage.getBoundingClientRect();
            svgOverlay.setAttribute('width', cameraImage.naturalWidth);
            svgOverlay.setAttribute('height', cameraImage.naturalHeight);
            svgOverlay.style.width = rect.width + 'px';
            svgOverlay.style.height = rect.height + 'px';
            
            drawPolygons();
        });
        
        // Draw polygons on SVG
        function drawPolygons() {
            svgOverlay.innerHTML = '';
            
            // Draw agent polygons (reference only)
            agentsData.forEach(agent => {
                if (agent.polygon && agent.polygon.length > 0) {
                    drawPolygon(agent.polygon, 'agent-polygon', agent.id, 'agent');
                }
            });
            
            // Draw object polygons (interactive)
            objectsData.forEach(obj => {
                if (obj.polygon && obj.polygon.length > 0) {
                    drawPolygon(obj.polygon, 'object-polygon', obj.id, 'object');
                }
            });
        }
        
        function drawPolygon(vertices, className, id, type) {
            const polygon = document.createElementNS('http://www.w3.org/2000/svg', 'polygon');
            const points = vertices.map(v => `${v[0]},${v[1]}`).join(' ');
            polygon.setAttribute('points', points);
            polygon.setAttribute('class', className);
            polygon.setAttribute('data-id', id);
            polygon.setAttribute('data-type', type);
            
            if (type === 'object') {
                polygon.addEventListener('mouseenter', () => highlightEntity(id, 'object'));
                polygon.addEventListener('mouseleave', () => unhighlightEntity(id, 'object'));
                polygon.addEventListener('click', () => focusObject(id));
            } else if (type === 'agent') {
                polygon.addEventListener('mouseenter', () => highlightEntity(id, 'agent'));
                polygon.addEventListener('mouseleave', () => unhighlightEntity(id, 'agent'));
            }
            
            svgOverlay.appendChild(polygon);
        }
        
        // Populate object list
        function populateObjectList() {
            objectList.innerHTML = '';
            
            objectsData.forEach(obj => {
                const item = document.createElement('div');
                item.className = 'object-item';
                item.setAttribute('data-id', obj.id);
                
                const nameDiv = document.createElement('div');
                nameDiv.className = 'object-name';
                nameDiv.textContent = obj.display_name;
                
                const select = document.createElement('select');
                select.className = 'owner-select';
                select.setAttribute('data-object-id', obj.id);
                
                // Add options
                const defaultOption = document.createElement('option');
                defaultOption.value = '';
                defaultOption.textContent = '-- Select Owner --';
                select.appendChild(defaultOption);
                
                agentsData.forEach(agent => {
                    const option = document.createElement('option');
                    option.value = agent.id;
                    option.textContent = agent.display_name;
                    select.appendChild(option);
                });
                
                // Set initial value if exists
                if (obj.owner && obj.owner !== 'room') {
                    select.value = obj.owner;
                    ownershipMap[obj.id] = obj.owner;
                }
                
                // Event listeners
                select.addEventListener('change', (e) => {
                    const ownerId = e.target.value;
                    if (ownerId) {
                        ownershipMap[obj.id] = ownerId;
                    } else {
                        delete ownershipMap[obj.id];
                    }
                });
                
                item.addEventListener('mouseenter', () => highlightEntity(obj.id, 'object'));
                item.addEventListener('mouseleave', () => unhighlightEntity(obj.id, 'object'));
                
                item.appendChild(nameDiv);
                item.appendChild(select);
                objectList.appendChild(item);
            });
        }
        
        // Populate agent list
        function populateAgentList() {
            agentList.innerHTML = '';
            
            agentsData.forEach(agent => {
                const item = document.createElement('div');
                item.className = 'agent-item';
                item.setAttribute('data-id', agent.id);
                item.textContent = agent.display_name;
                
                if (agent.id !== 'public') {
                    item.addEventListener('mouseenter', () => highlightEntity(agent.id, 'agent'));
                    item.addEventListener('mouseleave', () => unhighlightEntity(agent.id, 'agent'));
                }
                
                agentList.appendChild(item);
            });
        }
        
        // Highlight entity
        function highlightEntity(id, type) {
            // Highlight polygon
            const polygon = svgOverlay.querySelector(`[data-id="${id}"][data-type="${type}"]`);
            if (polygon) {
                polygon.classList.add('highlighted');
            }
            
            // Highlight list item
            const listItem = type === 'object' 
                ? objectList.querySelector(`[data-id="${id}"]`)
                : agentList.querySelector(`[data-id="${id}"]`);
            if (listItem) {
                listItem.classList.add('highlighted');
            }
        }
        
        // Unhighlight entity
        function unhighlightEntity(id, type) {
            const polygon = svgOverlay.querySelector(`[data-id="${id}"][data-type="${type}"]`);
            if (polygon) {
                polygon.classList.remove('highlighted');
            }
            
            const listItem = type === 'object'
                ? objectList.querySelector(`[data-id="${id}"]`)
                : agentList.querySelector(`[data-id="${id}"]`);
            if (listItem) {
                listItem.classList.remove('highlighted');
            }
        }
        
        // Focus on object (scroll into view)
        function focusObject(id) {
            const item = objectList.querySelector(`[data-id="${id}"]`);
            if (item) {
                item.scrollIntoView({ behavior: 'smooth', block: 'center' });
                item.classList.add('highlighted');
                setTimeout(() => item.classList.remove('highlighted'), 2000);
            }
        }
        
        // Submit ownership data
        submitButton.addEventListener('click', async () => {
            const ownerships = [];
            
            for (const [objectId, ownerId] of Object.entries(ownershipMap)) {
                const obj = objectsData.find(o => o.id === objectId);
                const agent = agentsData.find(a => a.id === ownerId);
                
                if (obj && agent) {
                    ownerships.push({
                        object_id: objectId,
                        object_name: obj.display_name,
                        owner_id: ownerId,
                        owner_name: agent.display_name
                    });
                }
            }
            
            if (ownerships.length === 0) {
                showStatus('Please assign at least one object to an owner', 'error');
                return;
            }
            
            try {
                submitButton.disabled = true;
                submitButton.textContent = 'â³ Saving...';
                
                const response = await fetch('/save_all_ownerships', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        ownerships: ownerships,
                        scene_name: sceneName,
                        session_id: `simple_tool_${new Date().getTime()}`
                    })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    showStatus(`âœ… Successfully saved ${result.count} ownership relationships!`, 'success');
                } else {
                    showStatus(`âŒ Error: ${result.error}`, 'error');
                }
            } catch (error) {
                showStatus(`âŒ Network error: ${error.message}`, 'error');
            } finally {
                submitButton.disabled = false;
                submitButton.textContent = 'ðŸ’¾ Save Ownership Data';
            }
        });
        
        function showStatus(message, type) {
            statusMessage.textContent = message;
            statusMessage.className = `status-message ${type}`;
            statusMessage.style.display = 'block';
            
            setTimeout(() => {
                statusMessage.style.display = 'none';
            }, 5000);
        }
        
        // Initialize
        populateObjectList();
        populateAgentList();
    </script>
</body>
</html>
